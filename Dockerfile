FROM debian:bullseye-slim

ENV LC_CTYPE C.UTF-8
RUN adduser --disabled-password --gecos '' pwn
RUN apt update && apt upgrade -y && apt install man manpages-dev less binwalk libglib2.0-dev gcc-9-plugin-dev elfutils curl openssl libc6-dbg vim tmux nasm gdb gcc-multilib clang lld llvm llvm-dev make cmake g++-multilib binutils bsdmainutils ninja-build bison flex libglib2.0-dev npm gdbserver libpixman-1-dev cargo libgtk-3-dev tmuxp file p7zip unzip procps python3 python3-pip python3-setuptools git xsel libssl-dev python3-dev libffi-dev build-essential ruby ruby-dev socat wget curl netcat python3-ipython ltrace strace -y --no-install-recommends && gem install one_gadget seccomp-tools && python3 -m pip install --upgrade pip wheel && wget https://github.com/Arinerron/heaptrace/releases/download/2.2.8/heaptrace_2.2.8.2-0_x86_64.deb -O /tmp/heaptrace.deb && dpkg -i /tmp/heaptrace.deb && wget 'https://github.com/GJDuck/e9afl/releases/download/v0.8.0/e9afl_0.8.0_amd64.deb' -O /tmp/e9afl && dpkg -i /tmp/e9afl && rm -rf /var/lib/apt/list/*

USER pwn
ENV PATH "$PATH:/home/pwn/.local/bin"
WORKDIR /home/pwn
RUN python3 -m pip install keystone-engine capstone ropper pwntools angr lief unicorn decomp2dbg && decomp2dbg --install && mkdir $HOME/tools $HOME/.config $HOME/.tmuxp && wget 'https://github.com/io12/pwninit/releases/download/3.2.0/pwninit' -O $HOME/.local/bin/pwninit && chmod +x $HOME/.local/bin/pwninit  && cd $HOME/tools && git clone https://github.com/pwndbg/pwndbg && cd ./pwndbg && pip install -r requirements.txt && echo "source $PWD/gdbinit.py" >> $HOME/.gdbinit && echo "set history save on" >> $HOME/.gdbinit && cd /tmp && git clone https://github.com/jacereda/fsatrace.git && cd ./fsatrace && make && cp fsatrace  fsatrace.so $HOME/tools && printf '[update]\ninterval=never' >> $HOME/.config/pwn.conf && cd $HOME/tools && git clone https://github.com/jfoote/exploitable.git && cd ./exploitable && echo "source $HOME/tools/exploitable/exploitable/exploitable.py" >> $HOME/.gdbinit && cd $HOME/tools && git clone https://github.com/AFLplusplus/AFLplusplus && cd ./AFLplusplus && make distrib && make && ln -s $(pwd)/afl-fuzz $HOME/.local/bin/
COPY files/tmux.conf /home/pwn/.tmux.conf
COPY files/vimrc /home/pwn/.vimrc
COPY files/sploit-rop.py /home/pwn/tools/
COPY files/sploit.py /home/pwn/tools/
COPY files/pwntools-cheatsheet.md /home/pwn/tools/
COPY files/preeny /home/pwn/tools/
COPY files/tmuxp-conf.yaml /home/pwn/.tmuxp/conf.yaml

WORKDIR /home/pwn/target
